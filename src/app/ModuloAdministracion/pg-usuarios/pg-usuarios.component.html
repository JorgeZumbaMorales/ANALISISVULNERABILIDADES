<p-toast></p-toast>


<section class="w-full bg-baseAzulOscuro text-textoSecundario rounded-2xl shadow-md px-4 sm:px-6 py-4 sm:py-4 mb-3">
  <!-- Encabezado de gestión -->
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h2 class="text-xl sm:text-2xl font-semibold">Gestión de Usuarios</h2>
      <p class="text-sm text-textoSecundario mt-1">Administra los usuarios registrados: agrega, edita o elimina según sea necesario.</p>
    </div>
    <p-button 
      icon="pi pi-plus" 
      label="Agregar Usuario"
      class=" "
      (click)="manejarModal('agregarUsuario', true)">
    </p-button>
  </div>
</section>
<section class="w-full bg-white border border-gray-200 rounded-2xl shadow-lg px-4 py-1">
  <p-table
  #dt
  [value]="usuarios"
  [customSort]="true"
  (sortFunction)="ordenarUsuariosRemovible($event)"
  dataKey="usuario_id"
  [paginator]="true"
  [rows]="5"
 [globalFilterFields]="['nombre_usuario', 'nombres_completos', 'email', 'estadoTexto', 'rolesTexto']"
  responsiveLayout="scroll"
  class="w-full"
>
<ng-template pTemplate="caption">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-2">
    <div class="bg-baseAzulOscuro text-white px-3 py-1 rounded-md shadow-sm">
      <h3 class="text-base sm:text-lg font-semibold">Lista de Usuarios</h3>
    </div>
    <p-iconfield iconPosition="left" class="mt-2 sm:mt-0">
      <p-inputicon>
        <i class="pi pi-search"></i>
      </p-inputicon>
      <input
        pInputText
        type="text"
        (input)="filtrarUsuarios($event)"
        placeholder="Buscar usuario..."
        class="w-full md:w-72"
      />
    </p-iconfield>
  </div>
</ng-template>
    <ng-template pTemplate="header">
      <tr>
  <th pSortableColumn="nombre_usuario">Usuario <p-sortIcon field="nombre_usuario" /></th>
  <th pSortableColumn="nombres_completos">Nombres <p-sortIcon field="nombres_completos" /></th>
  <th pSortableColumn="email">Email <p-sortIcon field="email" /></th>
  <th pSortableColumn="rolesTexto" class="text-left">
  Roles <p-sortIcon field="rolesTexto" />
</th>
  <th pSortableColumn="estado" class="text-center">
  Estado <p-sortIcon field="estado" />
</th>
  <th class="text-center w-[150px]">Acciones</th>
</tr>
    </ng-template>
    <ng-template pTemplate="body" let-usuario>
      <tr>
        <td>{{ usuario.nombre_usuario }}</td>
        <td>{{ usuario.nombres_completos }}</td>
        <td>{{ usuario.email }}</td>
        <td class="text-left">
  <ng-container *ngIf="usuario.roles?.length">
    <p-chip
      *ngFor="let rol of usuario.roles"
      [label]="rol"
      class="m-1   px-2 py-1 rounded-md text-sm">
    </p-chip>
  </ng-container>
</td>
        <td class="text-center">
          <p-tag 
            [value]="usuario.estado ? 'Activo' : 'Inactivo'"
            [severity]="usuario.estado ? 'success' : 'danger'">
          </p-tag>
        </td>
        <td class="text-center">
          <div class="flex justify-center gap-2">
            <p-button 
              icon="pi pi-pencil" 
              class=""
              (click)="editarUsuario(usuario)">
            </p-button>
            <p-button 
              icon="pi pi-trash" 
              class=""
              (click)="eliminarUsuario(usuario)">
            </p-button>
          </div>
        </td>
      </tr>
    </ng-template>
  </p-table>
</section>
<p-dialog class="modal-agregar-usuario" [(visible)]="modalesVisibles['agregarUsuario']"
    [modal]="true" [header]="'Crear Usuario'" [closable]="false"
    class="w-full max-w-[45vw] md:max-w-[50vw] lg:max-w-[40vw] xl:max-w-[38vw] 2xl:max-w-[36vw]">
    <form [formGroup]="formularioUsuario">
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
            <div class="flex flex-col gap-4">
                <p-iftalabel>
                    <input pInputText id="nombres_completos" formControlName="nombres_completos" autocomplete="off" class="w-full" />
                    <label for="nombres_completos">Nombres Completos</label>
                </p-iftalabel>
                <p-iftalabel>
                    <input pInputText id="nombre_usuario" formControlName="nombre_usuario" autocomplete="off" class="w-full" />
                    <label for="nombre_usuario">Nombre de Usuario</label>
                </p-iftalabel>
                <p-iftalabel>
                    <input pInputText id="email" formControlName="email" autocomplete="off" class="w-full" />
                    <label for="email">Correo Electrónico</label>
                </p-iftalabel>
                <p-iftalabel>
                    <p-password formControlName="contrasena" [feedback]="true" [toggleMask]="true" promptLabel="Ingrese una contraseña" 
                    weakLabel="Contraseña simple" mediumLabel="Contraseña media" strongLabel="Contraseña fuerte" appendTo="body" class="w-full">
                        <ng-template pTemplate="footer">
                            <p-divider />
                            <p class="mt-2">Recomendaciones:</p>
                            <ul class="pl-2 ml-2 mt-0" style="line-height: 1.5">
                                <li>Al menos una letra minúscula</li>
                                <li>Al menos una letra mayúscula</li>
                                <li>Al menos un número</li>
                                <li>Mínimo 8 caracteres</li>
                            </ul>
                        </ng-template>
                    </p-password>
                    <label for="password">Contraseña</label>
                </p-iftalabel>
            </div>
            <div class="flex flex-col gap-4">
                <p-iftalabel>
                    <input pInputText id="apellidos_completos" formControlName="apellidos_completos" autocomplete="off" class="w-full" />
                    <label for="apellidos_completos">Apellidos Completos</label>
                </p-iftalabel>
                <p-iftalabel class="w-full">
                    <p-multiSelect 
    id="rol_ids" 
    formControlName="rol_ids"
    [options]="roles" 
    optionLabel="label"
    display="chip"
    
    class="w-full">
  </p-multiSelect>

                    <label for="rol_id">Seleccione los roles</label>
                </p-iftalabel>
                <p-iftalabel>
                    <input pInputText id="telefono" formControlName="telefono" autocomplete="off" class="w-full" />
                    <label for="telefono">Número de Teléfono</label>
                </p-iftalabel>
                <p-iftalabel>
                    <p-password id="confirmar_contrasena" formControlName="confirmar_contrasena" 
                        promptLabel="Repita la contraseña" [toggleMask]="true" appendTo="body" class="w-full"
                         weakLabel="Contraseña simple" mediumLabel="Contraseña media" strongLabel="Contraseña fuerte">
                    </p-password>
                    <label for="password">Repetir contraseña</label>
                </p-iftalabel>
            </div>
        </div>
    </form>
    <div class="modal-footer flex justify-end items-center mt-6 space-x-4">
        <p-button label="Guardar" icon="pi pi-save" class="" (click)="guardarUsuario()"></p-button>
        <p-button label="Cancelar" icon="pi pi-times" class="" (click)="manejarModal('agregarUsuario', false)"></p-button> 
    </div>
</p-dialog>









