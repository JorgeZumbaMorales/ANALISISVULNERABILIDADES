<p-toast></p-toast>


<section class="w-full bg-baseAzulOscuro text-textoSecundario rounded-2xl shadow-md px-4 sm:px-6 py-4 sm:py-4 mb-3">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h2 class="text-xl sm:text-2xl font-semibold">An√°lisis de Vulnerabilidades por Dispositivo</h2>
      <p class="text-sm text-textoSecundario mt-1">
        Escanea un dispositivo o revisa los reportes de vulnerabilidades detectadas, incluyendo un resumen y recomendaciones.
      </p>
    </div>
  </div>
</section>


<section class="w-full mt-3 mb-6">
  

  <!-- üî∏ Subt√≠tulo y acciones -->
  <div class="w-full flex flex-col items-center mt-5 gap-4">
    <!-- üìù Submensaje centrado -->
    <p-message
      styleClass="text-white text-sm sm:text-base bg-baseAzulOscuro rounded-xl font-medium py-2 px-4 text-center"
      text="Selecciona un dispositivo activo y elige una acci√≥n.">
    </p-message>

    <!-- üîò Select + Botones -->
    <div class="flex flex-col sm:flex-row gap-3 items-center justify-center w-full sm:w-auto">
      
<p-iftalabel class="w-full sm:min-w-[16rem] sm:max-w-[22rem]">
  <p-select
    [(ngModel)]="dispositivoSeleccionado"
  (onChange)="onChangeDispositivo()"
    inputId="dd-dispositivo"
    [options]="dispositivos"
    optionLabel="nombre_dispositivo"
    appendTo="body"
    styleClass="w-full"
    [disabled]="analisisEnProgreso"
  >
    <ng-template let-dispositivo pTemplate="item">
      <div>
        <div class="font-semibold">{{ dispositivo.nombre_dispositivo }}</div>
        <div class="text-sm text-gray-500">
          MAC: {{ dispositivo.mac_address }} | IP: {{ dispositivo.ultima_ip }}
        </div>
      </div>
    </ng-template>
  </p-select>
  <label for="dd-dispositivo">Dispositivo</label>
</p-iftalabel>



      <!-- üîç Bot√≥n Escanear -->
      <p-button
  (click)="escanearDispositivo()"
  class="whitespace-nowrap"
  [styleClass]="'py-3 px-4'"
  [disabled]="analisisEnProgreso"
>

        <ng-container *ngIf="!cargando">
          <span class="flex items-center gap-2">
            <i class="pi pi-search"></i>
            Escanear vulnerabilidades
          </span>
        </ng-container>
        <ng-container *ngIf="cargando">
          <span class="flex items-center gap-2">
            <p-progress-spinner
              strokeWidth="8"
              fill="transparent"
              animationDuration=".5s"
              [style]="{ width: '20px', height: '20px' }"
            ></p-progress-spinner>
            Evaluando Dispositivo..
          </span>
        </ng-container>
      </p-button>

      <!-- üîÅ Bot√≥n Consultar -->
      <p-button
        icon="pi pi-refresh"
        label="Consultar √öltimo Escaneo"
        class="whitespace-nowrap"
        [styleClass]="'py-3 px-4'"
        (click)="consultarResultadoAnterior()"
        [disabled]="analisisEnProgreso"
      ></p-button>
    </div>
  </div>
</section>
<section
  *ngIf="resultadoPersistente && !cargando && !analisisEnProgreso && analisisFinalizado && resumenTecnico.length === 0 && mensajeErrorAnalisis"
  class="w-full bg-red-100 border border-red-300 rounded-xl p-5 text-red-900 shadow-inner"
>
  <div class="flex flex-col sm:flex-row items-center justify-center text-center gap-2">
    <div class="text-base sm:text-lg leading-snug">
      <strong>Error:</strong> {{ mensajeErrorAnalisis }}
    </div>
  </div>
</section>

<section
  *ngIf="resumenTecnico.length > 0"
  class="w-full mt-6 px-6 py-6 rounded-xl shadow-md border border-gray-200 bg-white space-y-6"
>
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <h3 class="text-xl font-semibold text-baseAzulOscuro">
      Resumen T√©cnico de Vulnerabilidades por Puerto
    </h3>

    <p-button
      label="Limpiar Resultados"
      severity="danger"
      (click)="limpiarResultado()"
    ></p-button>
  </div>

  <div class="flex flex-wrap gap-2">
    <p-chip
      *ngFor="let resumen of resumenTecnico"
      [label]="'Puerto ' + resumen.puerto"
      [class.bg-blue-100]="puertoSeleccionado?.puerto === resumen.puerto"
      [class.text-blue-800]="puertoSeleccionado?.puerto === resumen.puerto"
      [class.font-semibold]="puertoSeleccionado?.puerto === resumen.puerto"
      (click)="actualizarPuertoSeleccionado(resumen)"
      class="cursor-pointer px-3 py-2 text-sm rounded-full border"
    ></p-chip>
  </div>

  <div *ngIf="puertoSeleccionado" class="overflow-hidden rounded-lg border border-gray-100">
    <div class="bg-baseAzulOscuro text-white px-6 py-4">
      <h4 class="text-lg font-bold">
        Puerto {{ puertoSeleccionado.puerto }} ‚Äî Servicio: {{ puertoSeleccionado.servicio }}
      </h4>
      <p class="text-sm opacity-90 mt-1">
        Protocolo: {{ puertoSeleccionado.protocolo }}
      </p>
    </div>

    <div class="px-6 py-5 space-y-6 bg-white">
      <ng-container *ngFor="let bloque of bloquesResumen">
        <div>
          <h5 class="text-base font-semibold text-textoPrincipal border-b pb-1 mb-2">
            {{ bloque.titulo }}
          </h5>
          <p class="text-sm text-gray-700 text-justify leading-relaxed">
            {{ obtenerBloque(bloque.clave) }}
          </p>
        </div>
      </ng-container>

      <div class="bg-gray-50 p-4 rounded-md border">
        <h5 class="text-base font-semibold text-textoPrincipal mb-2">
          Recomendaciones
        </h5>
        <ul class="list-decimal list-inside text-sm text-gray-700 space-y-1 pl-2">
          <li *ngFor="let rec of obtenerRecomendaciones(puertoSeleccionado.resumen)">
            {{ rec }}
          </li>
        </ul>
      </div>

      <div class="text-right pt-2" *ngIf="puertoSeleccionado.vulnerabilidades?.length > 0">
        <p-button
          label="Ver CVE mencionados"
          icon="pi pi-search"
          class="p-button-sm"
          styleClass="p-button-rounded p-button-warning"
          (click)="abrirModalCves(puertoSeleccionado)"
        ></p-button>
      </div>
    </div>
  </div>
</section>






<p-dialog 
  header="CVEs relacionados con el puerto"
  [(visible)]="dialogoCvesVisible"
  [modal]="true"
  [style]="{ width: '800px' }"
  [dismissableMask]="true"
  [baseZIndex]="10000"
>
  <section class="space-y-4">
    <!-- üîç Buscador -->
    <div class="flex justify-end">
      <p-iconfield iconPosition="left" class="w-full sm:w-1/2">
        <p-inputicon>
          <i class="pi pi-search"></i>
        </p-inputicon>
        <input
          pInputText
          type="text"
          [(ngModel)]="busquedaCve"
          (ngModelChange)="tablaCves.filterGlobal($event, 'contains')"
          placeholder="Buscar CVE..."
          class="w-full"
        />
      </p-iconfield>
    </div>

    <!-- üìã Tabla -->
    <p-table
      #tablaCves
      [value]="cvesSeleccionados"
      [paginator]="true"
      [rows]="5"
      [rowsPerPageOptions]="[5, 10, 20]"
      [responsiveLayout]="'scroll'"
      [globalFilterFields]="['id', 'score', 'url']"
      sortField="score"
      [sortOrder]="-1"
      dataKey="id"
      class="w-full"
    >
      <ng-template pTemplate="header">
        <tr>
          <th pSortableColumn="id">ID CVE <p-sortIcon field="id" /></th>
          <th pSortableColumn="score">Nivel de riesgo <p-sortIcon field="score" /></th>
          <th pSortableColumn="url">M√°s informaci√≥n <p-sortIcon field="url" /></th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-cve>
        <tr>
          <td>{{ cve.id }}</td>
          <td>{{ cve.score ?? 'N/A' }}</td>
          <td>
            <a
              [href]="cve.url"
              target="_blank"
              class="text-blue-700 underline hover:text-blue-900"
            >
              Ver CVE
            </a>
          </td>
        </tr>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td colspan="3" class="text-center">No se encontraron CVEs relacionados.</td>
        </tr>
      </ng-template>
    </p-table>
  </section>
</p-dialog>











