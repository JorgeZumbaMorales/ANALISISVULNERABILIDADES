<p-toast></p-toast>
<section class="w-full bg-baseAzulOscuro text-textoSecundario rounded-2xl shadow-md px-4 sm:px-6 py-4 sm:py-4 mb-3">
  <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
    <div>
      <h2 class="text-xl sm:text-2xl font-semibold">Evaluación de Riesgo de Dispositivos</h2>
      <p class="text-sm text-textoSecundario mt-1">
        Evalúa los dispositivos detectados en la red según sus puertos abiertos y el nivel de riesgo asociado.
      </p>
    </div>

    <div class="mt-4 flex justify-end">
      <p-button 
        [disabled]="evaluacionEnProgreso"
        (click)="iniciarEvaluacionRiesgoConPolling()"
      >
        <ng-container *ngIf="!evaluacionEnProgreso">
          <i class="pi pi-search"></i>
          <span class="">Evaluar Riesgo</span>
        </ng-container>

        <ng-container *ngIf="evaluacionEnProgreso">
          <p-progress-spinner 
            strokeWidth="8" 
            fill="transparent" 
            animationDuration=".5s"
            [style]="{ width: '20px', height: '20px' }">
          </p-progress-spinner>
          <span class="ml-2">Evaluando...</span>
        </ng-container>

      </p-button>
    </div>
  </div>
</section>

<section class="w-full px-1 py-2 flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 my-3 ">
  <p-message 
    *ngIf="!evaluacionCompletada" 
    severity="contrast" 
    text="Presiona el botón 'Evaluar Riesgo' para comenzar la clasificación de los dispositivos activos.">
  </p-message>
</section>

<section 
  *ngIf="evaluacionCompletada"
  class="w-full flex flex-col sm:flex-row sm:flex-wrap sm:justify-center gap-4 px-4 my-4"
>
  <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4 w-full sm:w-auto">
    <p-card 
      *ngFor="let item of tarjetasRiesgo"
      class="border-l-4 shadow-sm"
      [ngClass]="item.borde"
      styleClass="bg-white rounded-xl px-4 py-3 text-center">
      <div class="flex flex-col items-center justify-center gap-2">
        <i [class]="item.icono + ' text-2xl ' + item.color"></i>
        <p class="font-semibold text-sm text-gray-700">{{ item.titulo }}</p>
        <p class="text-xl font-bold text-gray-900">
          {{ obtenerCantidadPorRiesgo(item.valor) }}
        </p>
      </div>
    </p-card>
  </div>
</section>

<div class="flex justify-center my-3 px-4" *ngIf="evaluacionCompletada">
  <p-button 
    label="Limpiar Evaluación"
    icon="pi pi-trash"
    styleClass="p-button-sm p-button-outlined text-gray-700 border-gray-300"
    (click)="limpiarEstadoEvaluacion()"
    tooltip="Borrar resultados actuales y permitir una nueva evaluación">
  </p-button>
</div>

<section class="w-full  border border-gray-200 rounded-2xl shadow-md px-4">
  <p-accordion [activeIndex]="evaluacionCompletada ? null : -1" [multiple]="true">
    
    <ng-container *ngFor="let riesgo of ['Alto', 'Medio', 'Bajo', 'Sin Riesgo']">
      <p-accordionTab 
        [header]="riesgo === 'Sin Riesgo' ? 'Dispositivos Sin Riesgo' : 'Dispositivos con Riesgo ' + riesgo"
        [disabled]="!evaluacionCompletada"
        pTooltip="Ver resultados"
        tooltipPosition="top"
        [attr.id]="'acordeon-' + riesgo"
      >
        <ng-container *ngIf="evaluacionCompletada">
          <ng-container *ngIf="obtenerDispositivos(riesgo).length > 0; else sinDispositivos">
            <ng-container *ngFor="let dispositivo of obtenerDispositivos(riesgo)">
<div class="bg-gray-50 border border-gray-200 rounded-lg">

  <!-- Header: Nombre, etiqueta y MAC -->
  <div class="flex flex-col sm:flex-row sm:items-center gap-2 sm:gap-4 p-4">
    <div class="flex items-center gap-2">
      <i class="pi pi-server text-lg"></i>
      <span class="font-semibold">{{ dispositivo.nombreDispositivo }}</span>
      <p-tag [value]="dispositivo.riesgo" [severity]="obtenerColorEtiqueta(dispositivo.riesgo)"></p-tag>
    </div>
    <span class="text-sm text-gray-500">({{ dispositivo.macAddress }})</span>
  </div>

  <p-divider class="m-0" />

  <!-- Sección de justificación -->
  <ng-container *ngIf="dispositivo.riesgo !== 'Sin Riesgo'; else soloResumenSinRiesgo">
    <div class="p-4">
      <h3 class="font-bold">Justificación:</h3>
      <div class="mt-2" *ngIf="dispositivo.descripcion">
        <p class="text-sm ">
          <i class="pi pi-info-circle text-red-700 mr-1"></i>
          {{ dispositivo.descripcion }}
        </p>
      </div>
    </div>

    <p-divider class="m-0" />

    <!-- Puertos abiertos -->
    <div class="p-4">
      <p class="text-sm font-semibold mb-2">Puertos Abiertos:</p>
      <div class="flex flex-wrap gap-2">
        <p-chip 
          *ngFor="let puerto of dispositivo.puertosAbiertos"
          [label]="puerto.numero + ' - ' + (puerto.servicio || 'Desconocido')"
          styleClass="bg-gray-100 text-gray-800 text-sm font-medium rounded-lg border border-gray-200 px-3 py-1 shadow-none">
        </p-chip>
      </div>
    </div>

    <p-divider class="m-0" />

    <!-- Selector de puertos -->
    <div class="p-4">
      <p-multiSelect 
  [options]="dispositivo.puertosAbiertos"
  optionLabel="label"  
  [(ngModel)]="dispositivo.puertosSeleccionados"
  placeholder="Selecciona puertos para recomendación"
  appendTo="body"
  class="w-full text-sm">
</p-multiSelect>

    </div>

    <!-- Botón de recomendaciones -->
    <div class="p-4 pt-0" *ngIf="dispositivo.puertosSeleccionados.length">
      <div class="flex justify-end">
        <p-button 
          [disabled]="dispositivo.cargandoRecomendaciones"
          (click)="mostrarRecomendaciones(dispositivo)">
          <ng-container *ngIf="!dispositivo.cargandoRecomendaciones">
            <i class="pi pi-shield"></i>
            <span class="ml-2">Ver Recomendaciones</span>
          </ng-container>
          <ng-container *ngIf="dispositivo.cargandoRecomendaciones">
            <p-progress-spinner 
              strokeWidth="8" 
              fill="transparent" 
              animationDuration=".5s"
              [style]="{ width: '20px', height: '20px' }">
            </p-progress-spinner>
            <span class="ml-2">Generando...</span>
          </ng-container>
        </p-button>
      </div>
    </div>
  </ng-container>

  <!-- Caso sin riesgo -->
  <ng-template #soloResumenSinRiesgo>
    <div class="p-4">
      <p class="text-sm text-gray-500">Este dispositivo no presenta puertos abiertos.</p>
    </div>
  </ng-template>

</div>




            </ng-container>
          </ng-container>
          <ng-template #sinDispositivos>
            <p class="text-sm text-gray-500 px-4 py-2">No hay dispositivos asociados a este nivel de riesgo.</p>
          </ng-template>
        </ng-container>

        <ng-container *ngIf="!evaluacionCompletada">
          <p class="text-sm text-gray-500">Evaluación pendiente. No hay datos disponibles aún.</p>
        </ng-container>
      </p-accordionTab>
    </ng-container>
  </p-accordion>
</section>


<p-dialog 
  [(visible)]="dialogoVisible" 
  header="Recomendaciones de Seguridad" 
  [modal]="true" 
  [style]="{width: '50vw'}"
  [closable]="true"
  [dismissableMask]="true">

  <div *ngIf="listaRecomendaciones.length > 0">
    <p-table [value]="listaRecomendaciones">
      <ng-template pTemplate="header">
        <tr>
          <th>Puerto</th>
          <th>Servicio</th>
          <th>Recomendación</th>
        </tr>
      </ng-template>
      <ng-template let-recomendacion pTemplate="body">
        <tr>
          <td>{{ recomendacion.numero }}</td>
          <td>{{ recomendacion.servicio || 'Desconocido' }}</td>
          <td>{{ recomendacion.recomendaciones }}</td>
        </tr>
      </ng-template>
    </p-table>
  </div>

  <div *ngIf="listaRecomendaciones.length === 0">
    <p class="text-center text-gray-500">No hay recomendaciones disponibles.</p>
  </div>
</p-dialog>
